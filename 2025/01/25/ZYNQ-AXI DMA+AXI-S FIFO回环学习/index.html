

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/favicon.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Sawen Moerjie">
  <meta name="keywords" content="FPGA Verilog MATLAB Coding">
  
    <meta name="description" content="DMA 简介DMA 是现代计算机的特色之一，是硬件实现存储器与存储器、存储器与 I&#x2F;O 设备之间直接进行高速数据传输的内存技术，它允许不同速率的设备进行沟通，而不需要依靠 CPU 的中断负载。如果不使用 DMA，那么 CPU 需要从数据源把每一个片段的数据复制到寄存器中，这个过程会一直占用 CPU 的资源。当使用 DMA 时，CPU 向 DMA 发送一个存储传输请求，当 DMA 控制器收到请求时就">
<meta property="og:type" content="article">
<meta property="og:title" content="AXI DMA+AXI-S FIFO回环学习">
<meta property="og:url" content="https://www.moerjielovecookie.icu/2025/01/25/ZYNQ-AXI%20DMA+AXI-S%20FIFO%E5%9B%9E%E7%8E%AF%E5%AD%A6%E4%B9%A0/index.html">
<meta property="og:site_name" content="Sawen_Blog">
<meta property="og:description" content="DMA 简介DMA 是现代计算机的特色之一，是硬件实现存储器与存储器、存储器与 I&#x2F;O 设备之间直接进行高速数据传输的内存技术，它允许不同速率的设备进行沟通，而不需要依靠 CPU 的中断负载。如果不使用 DMA，那么 CPU 需要从数据源把每一个片段的数据复制到寄存器中，这个过程会一直占用 CPU 的资源。当使用 DMA 时，CPU 向 DMA 发送一个存储传输请求，当 DMA 控制器收到请求时就">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://sawen-pic-blog.oss-cn-beijing.aliyuncs.com/2024after4202501251640116.png">
<meta property="og:image" content="https://sawen-pic-blog.oss-cn-beijing.aliyuncs.com/2024after4202501251637054.png">
<meta property="og:image" content="https://sawen-pic-blog.oss-cn-beijing.aliyuncs.com/2024after4202501251031208.png">
<meta property="og:image" content="https://sawen-pic-blog.oss-cn-beijing.aliyuncs.com/2024after4202501252113134.png">
<meta property="article:published_time" content="2025-01-24T16:00:00.000Z">
<meta property="article:modified_time" content="2025-01-27T04:52:16.000Z">
<meta property="article:author" content="Sawen Moerjie">
<meta property="article:tag" content="FPGA">
<meta property="article:tag" content="ZYNQ">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://sawen-pic-blog.oss-cn-beijing.aliyuncs.com/2024after4202501251640116.png">
  
  
  
  <title>AXI DMA+AXI-S FIFO回环学习 - Sawen_Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="//at.alicdn.com/t/c/font_3846514_kabxni94auf.css">
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/bynotes/texiao/source/css/shubiao.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"www.moerjielovecookie.icu","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/banner.png","onlypost":true,"offset_factor":4},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":"s1VuBxXCcgtXqVI9HAQm9qPr-gzGzoHsz","app_key":"ZRUva62YyRxmXoylVSg3mBBq","server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null},"woyaola":null,"cnzz":null},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 7.3.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Sawen_Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives" target="_self">
                <i class="iconfont icon-books"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories" target="_self">
                <i class="iconfont icon-th-large"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button"
                 data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="iconfont icon-book"></i>
                <span>文档</span>
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                
                  
                  
                  
                  <a class="dropdown-item" href="https://hexo.fluid-dev.com/" target="_self">
                    
                    <span>主题博客</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="https://hexo.fluid-dev.com/docs/guide/" target="_self">
                    
                    <span>配置指南</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="https://hexo.fluid-dev.com/docs/icon/" target="_self">
                    
                    <span>图标用法</span>
                  </a>
                
              </div>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="AXI DMA+AXI-S FIFO回环学习"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        Sawen Moerjie
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-01-25 00:00" pubdate>
           2025 年 01 月 25 日 , 凌晨 12:00 , 星期六
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          <!-- compatible with older versions-->
          2k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          17 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">AXI DMA+AXI-S FIFO回环学习</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="DMA-简介"><a href="#DMA-简介" class="headerlink" title="DMA 简介"></a>DMA 简介</h1><p>DMA 是现代计算机的特色之一，是硬件实现存储器与存储器、存储器与 I/O 设备之间直接进行高速数据传输的内存技术，它允许不同速率的设备进行沟通，而不需要依靠 CPU 的中断负载。<br>如果不使用 DMA，那么 CPU 需要从数据源把每一个片段的数据复制到寄存器中，这个过程会一直占用 CPU 的资源。当使用 DMA 时，CPU 向 DMA 发送一个存储传输请求，当 DMA 控制器收到请求时就会将数据从源地址搬运到目的地址，搬运过程中不消化 CPU 的资源，当传输完成后 DMA 控制器以中断的方式通知 CPU。<br>为了发起传输事务，DMA 控制器必须有：</p>
<ol>
<li>源地址</li>
<li>目的地址</li>
<li>传输长度<br>DMA 存储传输的过程如下： </li>
<li>处理器向 DMA 控制器发送一条 DMA 命令</li>
<li>DMA 控制器把数据从外设传输到存储器或从存储器搬运到存储器，而让 CPU 腾出手来做其它操作</li>
<li>数据传输完成后，DMA 控制器向 CPU 发出一个中断，来通知处理器 DMA 传输完成</li>
</ol>
<p>ZYNQ 提供两种 DMA，一种是集成在 PS 中的硬核 DMA，一种是 PL 中的软核 AXI DMA IP。<br>各种接口方式的比较如下：<br><img src="https://sawen-pic-blog.oss-cn-beijing.aliyuncs.com/2024after4202501251640116.png" srcset="/img/banner.png" lazyload alt="|500"><br>PL 的 DMA 和 AXI_HP 接口的传输适用于大量数据的高性能传输，带宽高，传输方式的拓扑图如下：<br><img src="https://sawen-pic-blog.oss-cn-beijing.aliyuncs.com/2024after4202501251637054.png" srcset="/img/banner.png" lazyload alt="|500"></p>
<h2 id="AXI-DMA-IP"><a href="#AXI-DMA-IP" class="headerlink" title="AXI DMA IP"></a>AXI DMA IP</h2><p>AXI Direct Memory Access（AXI DMA）IP 核在 AXI 4 内存映射和 AXI 4-Stream IP 接口之间提供高带宽直接储存访问。</p>
<p><img src="https://sawen-pic-blog.oss-cn-beijing.aliyuncs.com/2024after4202501251031208.png" srcset="/img/banner.png" lazyload alt="|500"><br>AXI DMA 用到了三种总线。AXI 4-Lite 用于对寄存器进行配置，AXI 4 Memory Map 总线用于读写 DDR 中的数据，AXI 4 Stream 总线用于 AXI DMA 对外设数据的读写，其中 AXI 4 Stream Master（MM 2 S，Memory Map to Stream）接口用于向 PL写入数据，AXI 4-Stream Slave (S 2 MM，Stream to Memory Map) 接口用于从 PL读取数据。<br>AXI DMA 提供 3 种模式，分别是 Direct Register 模式、Scatter/Gather 模式和 Cyclic DMA（循环 DMA）模式，常用的是 Direct Register 模式。<br>Direct Register DMA 模式即 Simple DMA 模式。Direct Register 模式提供了一种配置，用于在 MM 2 S 和 S 2 MM 通道上执行简单的 DMA 传输。Simple DMA（简单 DMA）允许应用程序在 DMA 和 Device 之间定义单个事务。它有两个通道：一个从 DMA 到 Device，另一个从 Device 到 DMA。这里有个地方需要大家注意下，在编写 Simple DMA（简单 DMA）代码时必须设置缓冲区地址和长度字段以启动相应通道中的传输。（其中 PL 对应 Device）</p>
<h3 id="Vivado-中的-IP-配置"><a href="#Vivado-中的-IP-配置" class="headerlink" title="Vivado 中的 IP 配置"></a>Vivado 中的 IP 配置</h3><p><img src="https://sawen-pic-blog.oss-cn-beijing.aliyuncs.com/2024after4202501252113134.png" srcset="/img/banner.png" lazyload></p>
<p><strong>Enable Scatter Gather Engine</strong><br>选中此选项可启用 Scatter Gather 模式操作，并在 AXI DMA 中包含 Scatter Gather Engine。取消选中此选项可启用 Direct Register 模式操作，但不包括 AXI DMA 中的 Scatter Gather Engine。禁用 Scatter Gather Engine 会使 Scatter/Gather Engine 的所有输出端口都绑定为零，并且所有输入端口都将保持打开状态。此处我们取消勾选 Enable Scatter Gather Engine<br><strong>Enable Micro DMA</strong><br>使能后会生成高度优化的 DMA，资源消耗较少，用于极少量数据的传输<br><strong>Width of Buffer Length Register</strong><br>该选项配置了 AXI DMA 单次最大能搬运多少个字节，字节数 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.186ex;" xmlns="http://www.w3.org/2000/svg" width="8.267ex" height="2.117ex" role="img" focusable="false" viewBox="0 -853.7 3654 935.7"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="msup" transform="translate(1055.8,0)"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D44A" d="M436 683Q450 683 486 682T553 680Q604 680 638 681T677 682Q695 682 695 674Q695 670 692 659Q687 641 683 639T661 637Q636 636 621 632T600 624T597 615Q597 603 613 377T629 138L631 141Q633 144 637 151T649 170T666 200T690 241T720 295T759 362Q863 546 877 572T892 604Q892 619 873 628T831 637Q817 637 817 647Q817 650 819 660Q823 676 825 679T839 682Q842 682 856 682T895 682T949 681Q1015 681 1034 683Q1048 683 1048 672Q1048 666 1045 655T1038 640T1028 637Q1006 637 988 631T958 617T939 600T927 584L923 578L754 282Q586 -14 585 -15Q579 -22 561 -22Q546 -22 542 -17Q539 -14 523 229T506 480L494 462Q472 425 366 239Q222 -13 220 -15T215 -19Q210 -22 197 -22Q178 -22 176 -15Q176 -12 154 304T131 622Q129 631 121 633T82 637H58Q51 644 51 648Q52 671 64 683H76Q118 680 176 680Q301 680 313 683H323Q329 677 329 674T327 656Q322 641 318 637H297Q236 634 232 620Q262 160 266 136L501 550L499 587Q496 629 489 632Q483 636 447 637Q428 637 422 639T416 648Q416 650 418 660Q419 664 420 669T421 676T424 680T428 682T436 683Z"></path></g><g data-mml-node="mi" transform="translate(1048,0)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(1393,0)"><path data-c="1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g><g data-mml-node="mi" transform="translate(1913,0)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path></g><g data-mml-node="mi" transform="translate(2274,0)"><path data-c="210E" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path></g></g></g></g></g></svg></mjx-container><br><strong>Address Width (32 - 64)</strong><br>指定地址空间的宽度，可以是 32 到 64 之间的任意值<br><strong>Enable Read Channel</strong><br>开启 AXI DMA 的读通道 MM 2 S，相关配置如下：</p>
<ul>
<li>Number of Channels：指定通道数。保持默认值 1</li>
<li>Memory Map Data Width：AXI MM 2 S 存储映射读取数据总线的数据位宽。有效值为 32、64、128、256、512 和 1024。此处保持默认值 32</li>
<li>Stream Data Width：AXI MM 2 S AXI 4-Stream 数据总线的数据位宽。该值必须小于或等于 Memory Map Data Width。有效值为 8、16、32、64、128、512 和 1024。此处保持默认值 32</li>
<li>Max Burst Size：突发分区粒度设置。此设置指定 MM 2 S 的 AXI 4-Memory Map 侧的突发周期的最大值。有效值为 2、4、8、16、32、64、128 和 256</li>
<li>Allow Unaligned Transfers：启用或禁用 MM 2 S 数据重新排列引擎（Data Realignment Engine，DRE）。选中时，DRE 被使能并允许在 MM 2 S 存储映射数据路径上数据重新对齐到 8 位的字节水平。对于 MM 2 S通道，则从内存中读取数据。如果 DRE 被使能，则数据读取可以从任何缓冲区地址字节偏移开始，并且读取数据被对齐，使得第一个字节读取是 AXI 4-Stream 上的第一个有效字节输出<br><strong>Enable Write Channel</strong><br>开启 AXI DMA 的写通道 S 2 MM，相关配置同上</li>
</ul>
<h1 id="Vitis-工程解析"><a href="#Vitis-工程解析" class="headerlink" title="Vitis 工程解析"></a>Vitis 工程解析</h1><h2 id="头文件引用和宏定义"><a href="#头文件引用和宏定义" class="headerlink" title="头文件引用和宏定义"></a>头文件引用和宏定义</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/***************************** Include Files *********************************/</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"xaxidma.h"</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"xparameters.h"</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"xil_exception.h"</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"xdebug.h"</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"xil_util.h"</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> XPAR_UARTNS550_0_BASEADDR</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"xuartns550_l.h"</span> <span class="hljs-comment">/* to use uartns550 */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> XPAR_INTC_0_DEVICE_ID</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"xintc.h"</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"xscugic.h"</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-comment">/************************** Constant Definitions *****************************/</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Device hardware build related constants.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DMA_DEV_ID XPAR_AXIDMA_0_DEVICE_ID</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> XPAR_AXI_7SDDR_0_S_AXI_BASEADDR</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DDR_BASE_ADDR XPAR_AXI_7SDDR_0_S_AXI_BASEADDR</span><br><span class="hljs-meta">#<span class="hljs-keyword">elif</span> defined(XPAR_MIG7SERIES_0_BASEADDR)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DDR_BASE_ADDR XPAR_MIG7SERIES_0_BASEADDR</span><br><span class="hljs-meta">#<span class="hljs-keyword">elif</span> defined(XPAR_MIG_0_C0_DDR4_MEMORY_MAP_BASEADDR)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DDR_BASE_ADDR XPAR_MIG_0_C0_DDR4_MEMORY_MAP_BASEADDR</span><br><span class="hljs-meta">#<span class="hljs-keyword">elif</span> defined(XPAR_PSU_DDR_0_S_AXI_BASEADDR)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DDR_BASE_ADDR XPAR_PSU_DDR_0_S_AXI_BASEADDR</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DDR_BASE_ADDR XPAR_PS7_DDR_0_S_AXI_BASEADDR <span class="hljs-comment">// 0x00100000</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DDR_BASE_ADDR</span><br><span class="hljs-meta">#<span class="hljs-keyword">warning</span> CHECK FOR THE VALID DDR ADDRESS IN XPARAMETERS.H, \</span><br><span class="hljs-meta">		DEFAULT SET TO 0x01000000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MEM_BASE_ADDR 0x01000000</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MEM_BASE_ADDR (DDR_BASE_ADDR + 0x01000000) <span class="hljs-comment">// 0x01100000</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> XPAR_INTC_0_DEVICE_ID</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> RX_INTR_ID XPAR_INTC_0_AXIDMA_0_S2MM_INTROUT_VEC_ID</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TX_INTR_ID XPAR_INTC_0_AXIDMA_0_MM2S_INTROUT_VEC_ID</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> RX_INTR_ID XPAR_FABRIC_AXIDMA_0_S2MM_INTROUT_VEC_ID</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TX_INTR_ID XPAR_FABRIC_AXIDMA_0_MM2S_INTROUT_VEC_ID</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TX_BUFFER_BASE (MEM_BASE_ADDR + 0x00100000) <span class="hljs-comment">// 0x01200000</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> RX_BUFFER_BASE (MEM_BASE_ADDR + 0x00300000) <span class="hljs-comment">// 0x01400000</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> RX_BUFFER_HIGH (MEM_BASE_ADDR + 0x004FFFFF) <span class="hljs-comment">// 0x015FFFFF</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> XPAR_INTC_0_DEVICE_ID</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INTC_DEVICE_ID XPAR_INTC_0_DEVICE_ID</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INTC_DEVICE_ID XPAR_SCUGIC_SINGLE_DEVICE_ID</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> XPAR_INTC_0_DEVICE_ID</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INTC XIntc</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INTC_HANDLER XIntc_InterruptHandler</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INTC XScuGic</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INTC_HANDLER XScuGic_InterruptHandler</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-comment">/* Timeout loop counter for reset</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> RESET_TIMEOUT_COUNTER 10000</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TEST_START_VALUE 0x1</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Buffer and Buffer Descriptor related constant definition</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_PKT_LEN 0x200</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NUMBER_OF_TRANSFERS 10</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POLL_TIMEOUT_COUNTER 1000000U</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NUMBER_OF_EVENTS 1</span><br></code></pre></td></tr></table></figure>
<p><code>#define DDR_BASE_ADDR XPAR_AXI_7SDDR_0_S_AXI_BASEADDR</code> 重新定义了 DDR 3 的基址.。数据读写的基址为 <code>#define MEM_BASE_ADDR (DDR_BASE_ADDR + 0x01000000) // 0x01100000</code> AXI DMA 读取数据的起始地址为 <code>#define TX_BUFFER_BASE (MEM_BASE_ADDR + 0x00100000) // 0x01200000</code>，写入地址为 <code>0x01400000</code></p>
<h2 id="定义函数和声明相关的-instance-和-flag-变量"><a href="#定义函数和声明相关的-instance-和-flag-变量" class="headerlink" title="定义函数和声明相关的 instance 和 flag 变量"></a>定义函数和声明相关的 instance 和 flag 变量</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**************************** Type Definitions *******************************/</span><br><br><span class="hljs-comment">/***************** Macros (Inline Functions) Definitions *********************/</span><br><br><span class="hljs-comment">/************************** Function Prototypes ******************************/</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DEBUG</span><br><span class="hljs-keyword">extern</span> <span class="hljs-type">void</span> <span class="hljs-title function_">xil_printf</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *format, ...)</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> XPAR_UARTNS550_0_BASEADDR</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">Uart550_Setup</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">CheckData</span><span class="hljs-params">(<span class="hljs-type">int</span> Length, u8 StartValue)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">TxIntrHandler</span><span class="hljs-params">(<span class="hljs-type">void</span> *Callback)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">RxIntrHandler</span><span class="hljs-params">(<span class="hljs-type">void</span> *Callback)</span>;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">SetupIntrSystem</span><span class="hljs-params">(INTC *IntcInstancePtr,</span><br><span class="hljs-params">						   XAxiDma *AxiDmaPtr, u16 TxIntrId, u16 RxIntrId)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">DisableIntrSystem</span><span class="hljs-params">(INTC *IntcInstancePtr,</span><br><span class="hljs-params">							  u16 TxIntrId, u16 RxIntrId)</span>;<br><br><span class="hljs-comment">/************************** Variable Definitions *****************************/</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Device instance definitions</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-type">static</span> XAxiDma AxiDma; <span class="hljs-comment">/* Instance of the XAxiDma */</span><br><br><span class="hljs-type">static</span> INTC Intc; <span class="hljs-comment">/* Instance of the Interrupt Controller */</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Flags interrupt handlers use to notify the application context the events.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">volatile</span> u32 TxDone;<br><span class="hljs-keyword">volatile</span> u32 RxDone;<br><span class="hljs-keyword">volatile</span> u32 Error;<br><br></code></pre></td></tr></table></figure>
<h2 id="Main-函数"><a href="#Main-函数" class="headerlink" title="Main 函数"></a>Main 函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*****************************************************************************/</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Main function</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This function is the main entry of the interrupt test. It does the following:</span><br><span class="hljs-comment"> *	Set up the output terminal if UART16550 is in the hardware build</span><br><span class="hljs-comment"> *	Initialize the DMA engine</span><br><span class="hljs-comment"> *	Set up Tx and Rx channels</span><br><span class="hljs-comment"> *	Set up the interrupt system for the Tx and Rx interrupts</span><br><span class="hljs-comment"> *	Submit a transfer</span><br><span class="hljs-comment"> *	Wait for the transfer to finish</span><br><span class="hljs-comment"> *	Check transfer status</span><br><span class="hljs-comment"> *	Disable Tx and Rx interrupts</span><br><span class="hljs-comment"> *	Print test status and exit</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @param	None</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @return</span><br><span class="hljs-comment"> *		- XST_SUCCESS if example finishes successfully</span><br><span class="hljs-comment"> *		- XST_FAILURE if example fails.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @note		None.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> ******************************************************************************/</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>{<br>	<span class="hljs-type">int</span> Status;<br>	XAxiDma_Config *Config;<br>	<span class="hljs-type">int</span> Tries = NUMBER_OF_TRANSFERS;<br>	<span class="hljs-type">int</span> Index;<br>	u8 *TxBufferPtr;<br>	u8 *RxBufferPtr;<br>	u8 Value;<br><br>	TxBufferPtr = (u8 *)TX_BUFFER_BASE;<br>	RxBufferPtr = (u8 *)RX_BUFFER_BASE;<br>	<span class="hljs-comment">/* Initial setup for Uart16550 */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> XPAR_UARTNS550_0_BASEADDR</span><br><br>	Uart550_Setup();<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>	xil_printf(<span class="hljs-string">"\r\n--- Entering main() --- \r\n"</span>);<br><br>	Config = XAxiDma_LookupConfig(DMA_DEV_ID);<br>	<span class="hljs-keyword">if</span> (!Config)<br>	{<br>		xil_printf(<span class="hljs-string">"No config found for %d\r\n"</span>, DMA_DEV_ID);<br><br>		<span class="hljs-keyword">return</span> XST_FAILURE;<br>	}<br>	<span class="hljs-keyword">else</span><br>	{<br>		xil_printf(<span class="hljs-string">"Config found for %d\r\n"</span>, DMA_DEV_ID);<br>	}<br><br>	<span class="hljs-comment">/* Initialize DMA engine */</span><br>	Status = XAxiDma_CfgInitialize(&amp;AxiDma, Config);<br><br>	<span class="hljs-keyword">if</span> (Status != XST_SUCCESS)<br>	{<br>		xil_printf(<span class="hljs-string">"Initialization failed %d\r\n"</span>, Status);<br>		<span class="hljs-keyword">return</span> XST_FAILURE;<br>	}<br>	<span class="hljs-keyword">else</span><br>	{<br>		xil_printf(<span class="hljs-string">"DMA Initialization success %d\r\n"</span>, Status);<br>	}<br><br>	<span class="hljs-keyword">if</span> (XAxiDma_HasSg(&amp;AxiDma))<br>	{<br>		xil_printf(<span class="hljs-string">"Device configured as SG mode \r\n"</span>);<br>		<span class="hljs-keyword">return</span> XST_FAILURE;<br>	}<br>	<span class="hljs-keyword">else</span><br>	{<br>		xil_printf(<span class="hljs-string">"Device configured as simple mode \r\n"</span>);<br>	}<br><br>	<span class="hljs-comment">/* Set up Interrupt system  */</span><br>	Status = SetupIntrSystem(&amp;Intc, &amp;AxiDma, TX_INTR_ID, RX_INTR_ID);<br>	<span class="hljs-keyword">if</span> (Status != XST_SUCCESS)<br>	{<br><br>		xil_printf(<span class="hljs-string">"Failed intr setup\r\n"</span>);<br>		<span class="hljs-keyword">return</span> XST_FAILURE;<br>	}<br><br>	<span class="hljs-comment">/* Disable all interrupts before setup */</span><br><br>	XAxiDma_IntrDisable(&amp;AxiDma, XAXIDMA_IRQ_ALL_MASK,<br>						XAXIDMA_DMA_TO_DEVICE);<br><br>	XAxiDma_IntrDisable(&amp;AxiDma, XAXIDMA_IRQ_ALL_MASK,<br>						XAXIDMA_DEVICE_TO_DMA);<br><br>	<span class="hljs-comment">/* Enable all interrupts */</span><br>	XAxiDma_IntrEnable(&amp;AxiDma, XAXIDMA_IRQ_ALL_MASK,<br>					   XAXIDMA_DMA_TO_DEVICE);<br><br>	XAxiDma_IntrEnable(&amp;AxiDma, XAXIDMA_IRQ_ALL_MASK,<br>					   XAXIDMA_DEVICE_TO_DMA);<br><br>	<span class="hljs-comment">/* Initialize flags before start transfer test  */</span><br>	TxDone = <span class="hljs-number">0</span>;<br>	RxDone = <span class="hljs-number">0</span>;<br>	Error = <span class="hljs-number">0</span>;<br><br>	Value = TEST_START_VALUE;<br><br>	<span class="hljs-keyword">for</span> (Index = <span class="hljs-number">0</span>; Index &lt; MAX_PKT_LEN; Index++)<br>	{<br>		TxBufferPtr[Index] = Value;<br><br>		Value = (Value + <span class="hljs-number">1</span>) &amp; <span class="hljs-number">0xFF</span>;<br>	}<br><br>	<span class="hljs-comment">/* Flush the buffers before the DMA transfer, in case the Data Cache</span><br><span class="hljs-comment">	 * is enabled</span><br><span class="hljs-comment">	 */</span><br>	Xil_DCacheFlushRange((UINTPTR)TxBufferPtr, MAX_PKT_LEN);<br>	Xil_DCacheFlushRange((UINTPTR)RxBufferPtr, MAX_PKT_LEN);<br>	<span class="hljs-comment">/* Send a packet */</span><br>	<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; Tries; i++)<br>	{<br><br>		Status = XAxiDma_SimpleTransfer(&amp;AxiDma, (UINTPTR)RxBufferPtr,<br>										MAX_PKT_LEN, XAXIDMA_DEVICE_TO_DMA);<br><br>		<span class="hljs-keyword">if</span> (Status != XST_SUCCESS)<br>		{<br>			<span class="hljs-keyword">return</span> XST_FAILURE;<br>		}<br><br>		Status = XAxiDma_SimpleTransfer(&amp;AxiDma, (UINTPTR)TxBufferPtr,<br>										MAX_PKT_LEN, XAXIDMA_DMA_TO_DEVICE);<br><br>		<span class="hljs-keyword">if</span> (Status != XST_SUCCESS)<br>		{<br>			<span class="hljs-keyword">return</span> XST_FAILURE;<br>		}<br><br>		Status = Xil_WaitForEventSet(POLL_TIMEOUT_COUNTER, NUMBER_OF_EVENTS, &amp;Error);<br>		<span class="hljs-keyword">if</span> (Status == XST_SUCCESS)<br>		{<br>			<span class="hljs-keyword">if</span> (!TxDone)<br>			{<br>				xil_printf(<span class="hljs-string">"Transmit error %d\r\n"</span>, Status);<br>				<span class="hljs-keyword">goto</span> Done;<br>			}<br>			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Status == XST_SUCCESS &amp;&amp; !RxDone)<br>			{<br>				xil_printf(<span class="hljs-string">"Receive error %d\r\n"</span>, Status);<br>				<span class="hljs-keyword">goto</span> Done;<br>			}<br>		}<br><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * Wait for TX done or timeout</span><br><span class="hljs-comment">		 */</span><br>		Status = Xil_WaitForEventSet(POLL_TIMEOUT_COUNTER, NUMBER_OF_EVENTS, &amp;TxDone);<br>		<span class="hljs-keyword">if</span> (Status != XST_SUCCESS)<br>		{<br>			xil_printf(<span class="hljs-string">"Transmit failed %d\r\n"</span>, Status);<br>			<span class="hljs-keyword">goto</span> Done;<br>		}<br><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * Wait for RX done or timeout</span><br><span class="hljs-comment">		 */</span><br>		Status = Xil_WaitForEventSet(POLL_TIMEOUT_COUNTER, NUMBER_OF_EVENTS, &amp;RxDone);<br>		<span class="hljs-keyword">if</span> (Status != XST_SUCCESS)<br>		{<br>			xil_printf(<span class="hljs-string">"Receive failed %d\r\n"</span>, Status);<br>			<span class="hljs-keyword">goto</span> Done;<br>		}<br><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * Test finished, check data</span><br><span class="hljs-comment">		 */</span><br>		Status = CheckData(MAX_PKT_LEN, <span class="hljs-number">0x1</span>);<br>		<span class="hljs-keyword">if</span> (Status != XST_SUCCESS)<br>		{<br>			xil_printf(<span class="hljs-string">"Data check failed\r\n"</span>);<br>			<span class="hljs-keyword">goto</span> Done;<br>		}<br>		xil_printf(<span class="hljs-string">"Transfer %d done\r\n"</span>, i + <span class="hljs-number">1</span>);<br>	}<br>	xil_printf(<span class="hljs-string">"Successfully ran AXI DMA interrupt Example\r\n"</span>);<br><br>	<span class="hljs-comment">/* Disable TX and RX Ring interrupts and return success */</span><br><br>	DisableIntrSystem(&amp;Intc, TX_INTR_ID, RX_INTR_ID);<br><br>Done:<br>	xil_printf(<span class="hljs-string">"--- Exiting main() --- \r\n"</span>);<br><br>	<span class="hljs-keyword">if</span> (Status != XST_SUCCESS)<br>	{<br>		<span class="hljs-keyword">return</span> XST_FAILURE;<br>	}<br><br>	<span class="hljs-keyword">return</span> XST_SUCCESS;<br>}<br></code></pre></td></tr></table></figure>
<p><code>Tries</code> 为测试回环的次数</p>
<h2 id="函数的实现"><a href="#函数的实现" class="headerlink" title="函数的实现"></a>函数的实现</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br></pre></td><td class="code"><pre><code class="hljs c">*****************************************************************************/<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This function checks data buffer after the DMA transfer is finished.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * We use the static tx/rx buffers.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @param	Length is the length to check</span><br><span class="hljs-comment"> * @param	StartValue is the starting value of the first byte</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @return</span><br><span class="hljs-comment"> *		- XST_SUCCESS if validation is successful</span><br><span class="hljs-comment"> *		- XST_FAILURE if validation is failure.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @note		None.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> ******************************************************************************/</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">CheckData</span><span class="hljs-params">(<span class="hljs-type">int</span> Length, u8 StartValue)</span><br>{<br>	u8 *RxPacket;<br>	<span class="hljs-type">int</span> Index = <span class="hljs-number">0</span>;<br>	u8 Value;<br><br>	RxPacket = (u8 *)RX_BUFFER_BASE;<br>	Value = StartValue;<br><br>	<span class="hljs-comment">/* Invalidate the DestBuffer before receiving the data, in case the</span><br><span class="hljs-comment">	 * Data Cache is enabled</span><br><span class="hljs-comment">	 */</span><br>	Xil_DCacheInvalidateRange((UINTPTR)RxPacket, Length);<br><br>	<span class="hljs-keyword">for</span> (Index = <span class="hljs-number">0</span>; Index &lt; Length; Index++)<br>	{<br>		<span class="hljs-keyword">if</span> (RxPacket[Index] != Value)<br>		{<br>			xil_printf(<span class="hljs-string">"Data error %d: %x/%x\r\n"</span>,<br>					   Index, RxPacket[Index], Value);<br><br>			<span class="hljs-keyword">return</span> XST_FAILURE;<br>		}<br>		Value = (Value + <span class="hljs-number">1</span>) &amp; <span class="hljs-number">0xFF</span>;<br>	}<br><br>	<span class="hljs-keyword">return</span> XST_SUCCESS;<br>}<br><br><span class="hljs-comment">/*****************************************************************************/</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This is the DMA TX Interrupt handler function.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * It gets the interrupt status from the hardware, acknowledges it, and if any</span><br><span class="hljs-comment"> * error happens, it resets the hardware. Otherwise, if a completion interrupt</span><br><span class="hljs-comment"> * is present, then sets the TxDone.flag</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @param	Callback is a pointer to TX channel of the DMA engine.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @return	None.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @note		None.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> ******************************************************************************/</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">TxIntrHandler</span><span class="hljs-params">(<span class="hljs-type">void</span> *Callback)</span><br>{<br><br>	u32 IrqStatus;<br>	<span class="hljs-type">int</span> TimeOut;<br>	XAxiDma *AxiDmaInst = (XAxiDma *)Callback;<br><br>	<span class="hljs-comment">/* Read pending interrupts */</span><br>	IrqStatus = XAxiDma_IntrGetIrq(AxiDmaInst, XAXIDMA_DMA_TO_DEVICE);<br><br>	<span class="hljs-comment">/* Acknowledge pending interrupts */</span><br><br>	XAxiDma_IntrAckIrq(AxiDmaInst, IrqStatus, XAXIDMA_DMA_TO_DEVICE);<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * If no interrupt is asserted, we do not do anything</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (!(IrqStatus &amp; XAXIDMA_IRQ_ALL_MASK))<br>	{<br><br>		<span class="hljs-keyword">return</span>;<br>	}<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * If error interrupt is asserted, raise error flag, reset the</span><br><span class="hljs-comment">	 * hardware to recover from the error, and return with no further</span><br><span class="hljs-comment">	 * processing.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> ((IrqStatus &amp; XAXIDMA_IRQ_ERROR_MASK))<br>	{<br><br>		Error = <span class="hljs-number">1</span>;<br><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * Reset should never fail for transmit channel</span><br><span class="hljs-comment">		 */</span><br>		XAxiDma_Reset(AxiDmaInst);<br><br>		TimeOut = RESET_TIMEOUT_COUNTER;<br><br>		<span class="hljs-keyword">while</span> (TimeOut)<br>		{<br>			<span class="hljs-keyword">if</span> (XAxiDma_ResetIsDone(AxiDmaInst))<br>			{<br>				<span class="hljs-keyword">break</span>;<br>			}<br><br>			TimeOut -= <span class="hljs-number">1</span>;<br>		}<br><br>		<span class="hljs-keyword">return</span>;<br>	}<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * If Completion interrupt is asserted, then set the TxDone flag</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> ((IrqStatus &amp; XAXIDMA_IRQ_IOC_MASK))<br>	{<br><br>		TxDone = <span class="hljs-number">1</span>;<br>	}<br>}<br><br><span class="hljs-comment">/*****************************************************************************/</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This is the DMA RX interrupt handler function</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * It gets the interrupt status from the hardware, acknowledges it, and if any</span><br><span class="hljs-comment"> * error happens, it resets the hardware. Otherwise, if a completion interrupt</span><br><span class="hljs-comment"> * is present, then it sets the RxDone flag.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @param	Callback is a pointer to RX channel of the DMA engine.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @return	None.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @note		None.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> ******************************************************************************/</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">RxIntrHandler</span><span class="hljs-params">(<span class="hljs-type">void</span> *Callback)</span><br>{<br>	u32 IrqStatus;<br>	<span class="hljs-type">int</span> TimeOut;<br>	XAxiDma *AxiDmaInst = (XAxiDma *)Callback;<br><br>	<span class="hljs-comment">/* Read pending interrupts */</span><br>	IrqStatus = XAxiDma_IntrGetIrq(AxiDmaInst, XAXIDMA_DEVICE_TO_DMA);<br><br>	<span class="hljs-comment">/* Acknowledge pending interrupts */</span><br>	XAxiDma_IntrAckIrq(AxiDmaInst, IrqStatus, XAXIDMA_DEVICE_TO_DMA);<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * If no interrupt is asserted, we do not do anything</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (!(IrqStatus &amp; XAXIDMA_IRQ_ALL_MASK))<br>	{<br>		<span class="hljs-keyword">return</span>;<br>	}<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * If error interrupt is asserted, raise error flag, reset the</span><br><span class="hljs-comment">	 * hardware to recover from the error, and return with no further</span><br><span class="hljs-comment">	 * processing.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> ((IrqStatus &amp; XAXIDMA_IRQ_ERROR_MASK))<br>	{<br><br>		Error = <span class="hljs-number">1</span>;<br><br>		<span class="hljs-comment">/* Reset could fail and hang</span><br><span class="hljs-comment">		 * NEED a way to handle this or do not call it??</span><br><span class="hljs-comment">		 */</span><br>		XAxiDma_Reset(AxiDmaInst);<br><br>		TimeOut = RESET_TIMEOUT_COUNTER;<br><br>		<span class="hljs-keyword">while</span> (TimeOut)<br>		{<br>			<span class="hljs-keyword">if</span> (XAxiDma_ResetIsDone(AxiDmaInst))<br>			{<br>				<span class="hljs-keyword">break</span>;<br>			}<br><br>			TimeOut -= <span class="hljs-number">1</span>;<br>		}<br><br>		<span class="hljs-keyword">return</span>;<br>	}<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * If completion interrupt is asserted, then set RxDone flag</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> ((IrqStatus &amp; XAXIDMA_IRQ_IOC_MASK))<br>	{<br><br>		RxDone = <span class="hljs-number">1</span>;<br>	}<br>}<br><br><span class="hljs-comment">/*****************************************************************************/</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This function setups the interrupt system so interrupts can occur for the</span><br><span class="hljs-comment"> * DMA, it assumes INTC component exists in the hardware system.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @param	IntcInstancePtr is a pointer to the instance of the INTC.</span><br><span class="hljs-comment"> * @param	AxiDmaPtr is a pointer to the instance of the DMA engine</span><br><span class="hljs-comment"> * @param	TxIntrId is the TX channel Interrupt ID.</span><br><span class="hljs-comment"> * @param	RxIntrId is the RX channel Interrupt ID.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @return</span><br><span class="hljs-comment"> *		- XST_SUCCESS if successful,</span><br><span class="hljs-comment"> *		- XST_FAILURE.if not successful</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @note		None.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> ******************************************************************************/</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">SetupIntrSystem</span><span class="hljs-params">(INTC *IntcInstancePtr,</span><br><span class="hljs-params">						   XAxiDma *AxiDmaPtr, u16 TxIntrId, u16 RxIntrId)</span><br>{<br>	<span class="hljs-type">int</span> Status;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> XPAR_INTC_0_DEVICE_ID</span><br><br>	<span class="hljs-comment">/* Initialize the interrupt controller and connect the ISRs */</span><br>	Status = XIntc_Initialize(IntcInstancePtr, INTC_DEVICE_ID);<br>	<span class="hljs-keyword">if</span> (Status != XST_SUCCESS)<br>	{<br><br>		xil_printf(<span class="hljs-string">"Failed init intc\r\n"</span>);<br>		<span class="hljs-keyword">return</span> XST_FAILURE;<br>	}<br><br>	Status = XIntc_Connect(IntcInstancePtr, TxIntrId,<br>						   (XInterruptHandler)TxIntrHandler, AxiDmaPtr);<br>	<span class="hljs-keyword">if</span> (Status != XST_SUCCESS)<br>	{<br><br>		xil_printf(<span class="hljs-string">"Failed tx connect intc\r\n"</span>);<br>		<span class="hljs-keyword">return</span> XST_FAILURE;<br>	}<br><br>	Status = XIntc_Connect(IntcInstancePtr, RxIntrId,<br>						   (XInterruptHandler)RxIntrHandler, AxiDmaPtr);<br>	<span class="hljs-keyword">if</span> (Status != XST_SUCCESS)<br>	{<br><br>		xil_printf(<span class="hljs-string">"Failed rx connect intc\r\n"</span>);<br>		<span class="hljs-keyword">return</span> XST_FAILURE;<br>	}<br><br>	<span class="hljs-comment">/* Start the interrupt controller */</span><br>	Status = XIntc_Start(IntcInstancePtr, XIN_REAL_MODE);<br>	<span class="hljs-keyword">if</span> (Status != XST_SUCCESS)<br>	{<br><br>		xil_printf(<span class="hljs-string">"Failed to start intc\r\n"</span>);<br>		<span class="hljs-keyword">return</span> XST_FAILURE;<br>	}<br><br>	XIntc_Enable(IntcInstancePtr, TxIntrId);<br>	XIntc_Enable(IntcInstancePtr, RxIntrId);<br><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><br>	XScuGic_Config *IntcConfig;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Initialize the interrupt controller driver so that it is ready to</span><br><span class="hljs-comment">	 * use.</span><br><span class="hljs-comment">	 */</span><br>	IntcConfig = XScuGic_LookupConfig(INTC_DEVICE_ID);<br>	<span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == IntcConfig)<br>	{<br>		<span class="hljs-keyword">return</span> XST_FAILURE;<br>	}<br><br>	Status = XScuGic_CfgInitialize(IntcInstancePtr, IntcConfig,<br>								   IntcConfig-&gt;CpuBaseAddress);<br>	<span class="hljs-keyword">if</span> (Status != XST_SUCCESS)<br>	{<br>		<span class="hljs-keyword">return</span> XST_FAILURE;<br>	}<br>	<span class="hljs-comment">//设置中断优先级和触发类型</span><br>	XScuGic_SetPriorityTriggerType(IntcInstancePtr, TxIntrId, <span class="hljs-number">0xA0</span>, <span class="hljs-number">0x3</span>);<br><br>	XScuGic_SetPriorityTriggerType(IntcInstancePtr, RxIntrId, <span class="hljs-number">0xA0</span>, <span class="hljs-number">0x3</span>);<br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Connect the device driver handler that will be called when an</span><br><span class="hljs-comment">	 * interrupt for the device occurs, the handler defined above performs</span><br><span class="hljs-comment">	 * the specific interrupt processing for the device.</span><br><span class="hljs-comment">	 */</span><br>	 <span class="hljs-comment">//设置中断处理函数</span><br>	Status = XScuGic_Connect(IntcInstancePtr, TxIntrId,<br>							 (Xil_InterruptHandler)TxIntrHandler,<br>							 AxiDmaPtr);<br>	<span class="hljs-keyword">if</span> (Status != XST_SUCCESS)<br>	{<br>		<span class="hljs-keyword">return</span> Status;<br>	}<br><br>	Status = XScuGic_Connect(IntcInstancePtr, RxIntrId,<br>							 (Xil_InterruptHandler)RxIntrHandler,<br>							 AxiDmaPtr);<br>	<span class="hljs-keyword">if</span> (Status != XST_SUCCESS)<br>	{<br>		<span class="hljs-keyword">return</span> Status;<br>	}<br>	<br>	XScuGic_Enable(IntcInstancePtr, TxIntrId);<br>	XScuGic_Enable(IntcInstancePtr, RxIntrId);<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>	<span class="hljs-comment">/* Enable interrupts from the hardware */</span><br><br>	Xil_ExceptionInit();<br>	Xil_ExceptionRegisterHandler(XIL_EXCEPTION_ID_INT,<br>								 (Xil_ExceptionHandler)INTC_HANDLER,<br>								 (<span class="hljs-type">void</span> *)IntcInstancePtr);<br><br>	Xil_ExceptionEnable();<br><br>	<span class="hljs-keyword">return</span> XST_SUCCESS;<br>}<br><br><span class="hljs-comment">/*****************************************************************************/</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This function disables the interrupts for DMA engine.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @param	IntcInstancePtr is the pointer to the INTC component instance</span><br><span class="hljs-comment"> * @param	TxIntrId is interrupt ID associated w/ DMA TX channel</span><br><span class="hljs-comment"> * @param	RxIntrId is interrupt ID associated w/ DMA RX channel</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @return	None.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @note		None.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> ******************************************************************************/</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">DisableIntrSystem</span><span class="hljs-params">(INTC *IntcInstancePtr,</span><br><span class="hljs-params">							  u16 TxIntrId, u16 RxIntrId)</span><br>{<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> XPAR_INTC_0_DEVICE_ID</span><br>	<span class="hljs-comment">/* Disconnect the interrupts for the DMA TX and RX channels */</span><br>	XIntc_Disconnect(IntcInstancePtr, TxIntrId);<br>	XIntc_Disconnect(IntcInstancePtr, RxIntrId);<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>	XScuGic_Disconnect(IntcInstancePtr, TxIntrId);<br>	XScuGic_Disconnect(IntcInstancePtr, RxIntrId);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>}<br><br></code></pre></td></tr></table></figure>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/FPGA/" class="category-chain-item">FPGA</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/FPGA/" class="print-no-link">#FPGA</a>
      
        <a href="/tags/ZYNQ/" class="print-no-link">#ZYNQ</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>AXI DMA+AXI-S FIFO回环学习</div>
      <div>https://www.moerjielovecookie.icu/2025/01/25/ZYNQ-AXI DMA+AXI-S FIFO回环学习/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Sawen Moerjie</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年1月25日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/01/27/ZYNQ-PS%20GPIO%E4%B8%AD%E6%96%AD%E8%BF%87%E7%A8%8B/" title="ZYNQ-PS GPIO中断过程">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">ZYNQ-PS GPIO中断过程</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/01/24/hexo%E9%83%A8%E7%BD%B2%E5%88%B0github%20page%E6%97%B6%EF%BC%8Chexo%20d%E5%90%8Epage%E9%87%8C%E9%9D%A2%E7%BB%91%E5%AE%9A%E7%9A%84%E4%B8%AA%E4%BA%BA%E5%9F%9F%E5%90%8D%E6%B6%88%E5%A4%B1%E7%9A%84%E9%97%AE%E9%A2%98/" title="hexo部署到github page时，hexo d后page里面绑定的个人域名消失的问题">
                        <span class="hidden-mobile">hexo部署到github page时，hexo d后page里面绑定的个人域名消失的问题</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments">
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"你的appId","appKey":"你的appKey","path":"window.location.pathname","placeholder":"留言仅限讨论，禁止广告等行为","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"你的serverURLs","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  

</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    
      <script  src="/js/img-lazyload.js" ></script>
    
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>




  
<script src="//cdn.jsdelivr.net/gh/bynotes/texiao/source/js/love.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
